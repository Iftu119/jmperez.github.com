<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jose M. Perez&#39;s Blog</title>
  <subtitle>Web development, performance, and some other good practices.</subtitle>
  <link href="/tag/facebook/atom.xml" rel="self"/>
  
  <link href="https://jmperezperez.com/"/>
  <updated>2019-11-18T19:30:25.535Z</updated>
  <id>https://jmperezperez.com/</id>
  
  <author>
    <name>Jose M. Perez</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>The role of Solutions Engineer at Facebook</title>
    <link href="https://jmperezperez.com/solutions-engineer-facebook/"/>
    <id>https://jmperezperez.com/solutions-engineer-facebook/</id>
    <published>2019-11-18T06:00:00.000Z</published>
    <updated>2019-11-18T19:30:25.535Z</updated>
    
    <content type="html"><![CDATA[<p>Before joining Facebook as a Solutions Engineer I had many questions about what the role implied and if it was a good fit for me. After almost one year into the role I wanted to share more about what we do and inspire you.</p><div style="position:relative;padding-bottom:56.25%;margin-bottom:1rem"><img style="max-width:100%; border: 0;position:absolute;top:0;left:0" sizes="(max-width: 768px) 100vw, 684px" srcset="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:400,f_auto/v1574089969/solutions-engineer-facebook_bke37d.jpg 400w, https://res.cloudinary.com/jmperez/image/upload/w_auto:100:800,f_auto/v1574089969/solutions-engineer-facebook_bke37d.jpg 800w, https://res.cloudinary.com/jmperez/image/upload/w_auto:100:1200,f_auto/v1574089969/solutions-engineer-facebook_bke37d.jpg 1200w, https://res.cloudinary.com/jmperez/image/upload/w_auto:100:1400,f_auto/v1574089969/solutions-engineer-facebook_bke37d.jpg 1400w" src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1574089969/solutions-engineer-facebook_bke37d.jpg" alt="Solutions Engineer sign at Facebook"></div><p>I had been working as a software engineer for 10+ years, mainly building web applications. I was starting to feel that I didn‚Äôt enjoy dedicating 100% of my time to code, and wanted to understand why I was building what I was building.</p><a id="more"></a><p>What kind of metrics was I trying to move? How did I validate that the project was successful? How did I iterate on it once the initial version was shipped? And, especially, how could I propose and drive projects that I thought could be valuable to the company?</p><p>I wanted to apply technology to solve business problems, and move away from seeing technology as a goal itself.</p><p>I had never heard of the ‚ÄúSolutions Engineer‚Äù role, but when people at Facebook described it to me it was clear what gaps it was trying to solve.</p><div style="text-align:center; border: 1px solid #aaa; padding: 1em; margin: 1em">üëâ <a href="https://www.facebook.com/careers/life/solutions-engineering-at-facebook/" target="_blank" rel="noopener">We have open positions for Solutions Engineers</a>, including <a href="https://www.facebook.com/careers/jobs/566055030811900/" target="_blank" rel="noopener">one based in Stockholm</a>. <a href="/about-me/#Contact">Reach out to me if you want to know more</a>.</div><h2 id="What-is-a-Solutions-Engineer-at-Facebook"><a href="#What-is-a-Solutions-Engineer-at-Facebook" class="headerlink" title="What is a Solutions Engineer at Facebook"></a>What is a Solutions Engineer at Facebook</h2><p>Having worked previously building public APIs I felt that disconnection between consumers (partners, small and large developers) and internal teams. Advocating for a technology can get you somewhere, but if you are not able to address consumer‚Äôs feedback, identify opportunities and test them, then you won‚Äôt get far.</p><p>Solutions Engineer partner with companies that advertise on Facebook (Facebook, Instagram, Messenger, Whatsapp) and help them make sound decisions on their technical integration. This goes all the way from how they setup basic events on their website to know what actions users are performing during a purchase flow, to fully automate campaigns with dynamic creatives, audiences and bidding.</p><p>Best of all is that <strong>Solutions Engineers are engineers</strong>. This might seem obvious from the role title, but it holds true on a daily basis. We identify business opportunities that can‚Äôt be addressed with our current tools, create proposals, validate them by building them ourselves, and scale. We are the ones closest to the advertiser and the best to help product teams making their projects succeed with real customers.</p><h2 id="How-is-it-in-practice"><a href="#How-is-it-in-practice" class="headerlink" title="How is it in practice?"></a>How is it in practice?</h2><p>Most of my colleagues have created their own companies or have worked as CTOs. And in practice, one would say we act sometimes as mini-CTOs inside the teams working with advertisers. <strong>We care about the advertiser‚Äôs challenges</strong> (eg increase brand awareness, sell more products, increase gross margin, reduce churn of users) and help out using our tools.</p><p>We are not told what to do and it is expected that we pull help from product teams, design, or marketing to propose and drive projects. And ultimately, prove that it drove some measurable impact to both the advertiser and Facebook. All this while getting access to the data and tools you need to do your job keeping process at a minimum. I must say I‚Äôm greatly surprised how smooth this works at Facebook, taking into account its humongous size.</p><p><strong>This level of freedom and trust comes with a downside</strong>. If you are used to being told what to do, then this is not an environment you will thrive at first. This can be challenging but in the long term is highly rewarding. There is the expectation that you come up with ideas, so rather than people telling you to keep yourself within your role‚Äôs boundaries, you will see colleagues supporting you all the way.</p><p>The role is very flexible and every Solutions Engineer works differently. Some are working with advertisers within a certain vertical (ecomm, retail, travel, fintech, games‚Ä¶), others within a certain region. For instance, I support advertisers in the Nordics across all verticals.</p><p>Each company has their own unique challenges, and the goal is to identify how our solutions are falling short and how we can improve it, without shortcuts. Evey new project adds complexity: more code to maintain, more products to support users with, a bigger surface prone to bugs. That‚Äôs why we align with other Solutions Engineers working to identify similar problems with the advertisers they work with, and help build a case for a project that doesn‚Äôt solve a specific limitation for a company, but can scale. Ultimately <strong>the tools that a large company can use to do marketing on Facebook are the same ones you and I can use</strong>.</p><h2 id="Want-to-apply-or-know-more"><a href="#Want-to-apply-or-know-more" class="headerlink" title="Want to apply or know more?"></a>Want to apply or know more?</h2><p>If this sounds interesting, please reach out on Twitter or email. <strong><a href="https://www.facebook.com/careers/life/solutions-engineering-at-facebook/" target="_blank" rel="noopener">We have open positions for the role</a></strong>, including <a href="https://www.facebook.com/careers/jobs/566055030811900/" target="_blank" rel="noopener">one based in Stockholm</a> where you would work side by side with me. I‚Äôm also genuinely <strong>interested in talking with colleagues working at companies that could benefit from having a similar role</strong>, so <a href="/about-me/#Contact">reach out if you want to have a chat</a>.</p>]]></content>
    
    <summary type="html">
    
      Solutions Engineers partner with advertisers to solve their business challenges through Facebook technology. This is my take on what the role involves.
    
    </summary>
    
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
  </entry>
  
  <entry>
    <title>Using WebP to create tiny preview images</title>
    <link href="https://jmperezperez.com/webp-placeholder-images/"/>
    <id>https://jmperezperez.com/webp-placeholder-images/</id>
    <published>2015-11-28T10:30:00.000Z</published>
    <updated>2019-10-31T22:46:22.874Z</updated>
    
    <content type="html"><![CDATA[<p>Following with the image optimization topic, I am going to have a deeper look to <a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target="_blank" rel="noopener">Facebook‚Äôs technique to create <em>preview</em> photos</a>, and will show how WebP can simplify their solution.</p><p><img src="/assets/images/posts/webp-vs-jpeg-preview-photos.jpg" alt="WebP vs JPEG when encoding tiny images"></p><p><strong>tl;dr</strong> WebP produces tiny files when compressing small images. This makes it ideal for implementing <em>preview photos</em>. <a href="/demos/webp-preview/">Check the demo</a>.</p><a id="more"></a><p>In a recent article I talked about <a href="/medium-image-progressive-loading-placeholder/">an image loading technique used by Medium</a> that combined a small blurry preview plus a transition to the final image. This approach has been used for some time by other sites and mobile applications, and it is getting even more focus these days as major websites try to expand in countries with very slow internet connections.</p><p>Facebook is one of them and explained some months ago <a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target="_blank" rel="noopener">how they inlined preview photos</a>.</p><h2 id="Finding-out-the-right-image-dimensions"><a href="#Finding-out-the-right-image-dimensions" class="headerlink" title="Finding out the right image dimensions"></a>Finding out the right image dimensions</h2><p>There is a direct relation between the dimensions of the image, its size in bytes, and the radius for the blur effect that needs to be applied to smooth the big upscaled pixels. In addition, we need to take into account the rendered dimensions of the image: we will want a larger preview the larger the rendered size is.</p><p>Facebook found that, for their mobile client, the sweet spot for the preview size was 42√ó42px. Then, they tried to generate the smallest (in bytes) image that they could serve with those dimensions. JPEG was the winning format, and they worked on reducing the file size even further by making the mobile client prepend a common header image and only transmit the basic image data.</p><h2 id="Taking-this-approach-to-the-web"><a href="#Taking-this-approach-to-the-web" class="headerlink" title="Taking this approach to the web"></a>Taking this approach to the web</h2><p>If we want to use the same technique on a website, we need to:</p><ol><li>Send image data.</li><li>Send the header.</li><li>Send the JS code that will glue the header and the data together.</li></ol><p>In the case of a mobile app, the code for (2) and (3) is shipped as part of the app. But in a website we need to send it as part of the response. This means that, at least the first time the user visits our page, there won‚Äôt be large savings using this technique. For subsequent requests, we could use cached JS or a Service Worker to do the glueing process.</p><p>But not everything is lost.</p><h2 id="Using-a-different-image-format"><a href="#Using-a-different-image-format" class="headerlink" title="Using a different image format"></a>Using a different image format</h2><p>I wondered how other format files performed in file size when saving small files. I tried with PNG and GIF, and both of them were larger than JPG. Then I have it a try to WebP and I was surprised on how well it compresses images.</p><h3 id="How-I-resized-and-compressed-the-images"><a href="#How-I-resized-and-compressed-the-images" class="headerlink" title="How I resized and compressed the images"></a>How I resized and compressed the images</h3><p><strong><a href="/demos/webp-preview/">In this page</a> you can see the demo and all the source images generated</strong></p><p>First, I downloaded some 64√ó64px cover art images using the <a href="https://developer.spotify.com/web-api/console/get-artist-albums/?id=61C3cEhdoJ9YiQSQSwYB4K" target="_blank" rel="noopener">Spotify Web API</a>. I wanted to use square images with a consistent small size.</p><p>Then I used Photoshop to create a 42√ó42px JPEG version of the files, with the minimum quality settings (that is, max compression). Then I passed them through <a href="https://imageoptim.com/" target="_blank" rel="noopener">ImageOptim</a>, that saved around 66% of the file size using a lossless optimization. The final average file size is 478 bytes. <a href="/assets/images/posts/imageoptim-jpg-optimization.png"><img src="/assets/images/posts/imageoptim-jpg-optimization.png" alt="ImageOptim squeezing JPGs"></a></p><p>Note that Facebook don‚Äôt mention what the size for their images was:</p><blockquote><p>‚ÄúUnfortunately, the standard JPEG header is hundreds of bytes in size. In fact, the JPEG header alone is several times bigger than our entire 200-byte budget. However, excluding the JPEG header, the encoded data payload itself was approaching our 200 bytes‚Äù - taken from <a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target="_blank" rel="noopener">The technology behind preview photos</a>.</p></blockquote><p>For the WebP version I used Photoshop to create a 42√ó42 px JPEG version of the files, but this time with the maximum quality settings. This is to make sure that I didn‚Äôt introduce artifacts that WebP had to encode. Then again, I passed the files through ImageOptim, reducing the file size around 25%, to an average of 2.5kB.</p><p>Finally, I run <a href="https://developers.google.com/speed/webp/docs/using" target="_blank" rel="noopener"><code>cwebp</code></a> to generate WebP images from the JPEG version, with the minimum quality:</p><pre class=" language-bash"><code class="language-bash"><span class="token keyword">for</span> f <span class="token keyword">in</span> *.jpg<span class="token punctuation">;</span> <span class="token keyword">do</span> cwebp -q 0 <span class="token variable">$f</span> -o <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $f .jpg<span class="token variable">)</span></span>"</span>.webp<span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre><p>The resulting WebP images have a file size between 90 and 202 bytes, with an average of 121 bytes. That is <strong>25% of an equivalent JPG image</strong>. <a href="/assets/images/posts/webp-vs-jpeg-preview-photos.jpg"><img src="/assets/images/posts/webp-vs-jpeg-preview-photos.jpg" alt="WebP vs JPEG encoding tiny placeholder images"></a></p><p>The artifacts generated by JPEG and WebP are quite different, but in any case, when smoothed using blur, they look almost identical: <a href="/assets/images/posts/webp-vs-jpeg-preview-photos-blur.jpg"><img src="/assets/images/posts/webp-vs-jpeg-preview-photos-blur.jpg" alt="WebP vs JPEG encoding tiny placeholder images after applying a small blur effect"></a></p><p>Remember that these images are always shown with a blur effect, to smooth artifacts and pixels.</p><h3 id="Medium‚Äôs-Progressive-Loading-Inlined-WebP"><a href="#Medium‚Äôs-Progressive-Loading-Inlined-WebP" class="headerlink" title="Medium‚Äôs Progressive Loading + Inlined WebP"></a>Medium‚Äôs Progressive Loading + Inlined WebP</h3><p>I have forked the CodePen I created on <a href="/medium-image-progressive-loading-placeholder/">How Medium does progressive image loading</a> to show how it works with WebP. You will need a browser that supports WebP to see the full effect. Otherwise, you can <a href="/assets/images/posts/webp-progressive-image-loading.mp4">watch this video</a> showing the effect.</p><p>I have resized the original image to a 42√ó28px thumbnail, converted to WebP and generated its Data URI:</p><pre><code>data:image/webp;base64,UklGRnoAAABXRUJQVlA4IG4AAABQBQCdASoqABwAP/3+/3+/urWyMBVYA/A/iWIAAR7p/Y3etgh4KD8QqXEZj6waibITSIAA/cndnUz4/z4LEgByYUql75Cq/12W33KFIKQpc8L0Dt19C7NFXin0tKlxd70dzSF978msbuqLjDgAAA==
</code></pre><p>That‚Äôs 199 characters. And this is the result:</p><iframe id="cp_embed_QjeWVv" src="//codepen.io/jmperez/embed/QjeWVv?height=403&theme-id=0&slug-hash=QjeWVv&default-tab=result" scrolling="no" frameborder="no" height="403" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe" data-amp-width="100%" style="width: 100%; overflow: hidden"></iframe><p>You can see it better <a href="http://codepen.io/jmperez/full/QjeWVv/" target="_blank" rel="noopener">in full screen</a>. I recommend that you use network throttling and disable cache to notice the full animation.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We have managed to create a file within the 200 bytes budget without having to mess with the headers nor fancy low-level hacks. <em>Here‚Äôs when I wonder if it would be possible to strip the header of the WebP files and get even higher savings</em>.</p><p>For the web, <a href="http://caniuse.com/#feat=webp" target="_blank" rel="noopener">WebP can only be used in Chrome and Opera</a>, which limits its applicability in the real world. Interestingly for Facebook‚Äôs use case, WebP is supported on native mobile apps on <a href="https://github.com/carsonmcdonald/WebP-iOS-example" target="_blank" rel="noopener">iOS</a> and <a href="https://github.com/EverythingMe/webp-android" target="_blank" rel="noopener">Android</a>, so they could well use WebP as an alternative to their <em>technology</em>.</p>]]></content>
    
    <summary type="html">
    
      Following with the image optimization topic, I am going to have a deeper look to Facebook&#39;s technique to create preview photos, and will show how WebP can simplify their solution.
    
    </summary>
    
    
      <category term="images" scheme="https://jmperezperez.com/tags/images/"/>
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
      <category term="webp" scheme="https://jmperezperez.com/tags/webp/"/>
    
      <category term="ux" scheme="https://jmperezperez.com/tags/ux/"/>
    
  </entry>
  
  <entry>
    <title>Facebook news feed: Unifying mobile and desktop</title>
    <link href="https://jmperezperez.com/facebook-news-feed-redesign/"/>
    <id>https://jmperezperez.com/facebook-news-feed-redesign/</id>
    <published>2013-03-08T11:51:05.000Z</published>
    <updated>2019-10-31T22:46:22.869Z</updated>
    
    <content type="html"><![CDATA[<p>You probably know already about <a href="http://www.engadget.com/2013/03/07/facebook-freshens-up-news-feed/" target="_blank" rel="noopener">the redesign Facebook will be carrying out to their News Feed</a>. After reading some articles covering their presentation, there are lots of mentions to ‚Äúclutter reduction‚Äù, ‚Äúmore space for pictures‚Äù, ‚Äúmore info about check-ins‚Äù, etc. What I personally think is that Facebook has decided, simply, to unify their layout across devices. <img src="/assets/images/posts/facebook-news-feed.jpg" alt="Facebook News Feed Update"></p><a id="more"></a><p>And that is clearly visible when you have a look at their page about the redesigned news feed. They show, side by side, the same news feed as seen on the desktop website and an Android phone, iPhone and iPad mini. Unifying the design provides lots of advantages. On one side, users don‚Äôt need to adapt to a different experience when they browse Facebook, regardless of the device they are using. On the other, it highly simplifies the different content formats, what makes it easier for partners (apps, ads‚Ä¶) to provide content that will behave the same way in every device.</p><p>This movement shows how Facebook really thinks about mobile devices, and how they put them at the same level as their main desktop site. It is a step beyond responsive design. It is more how the layout used for smartphones and tablets has conditioned their desktop site.</p><p>Anyway, I am looking forward to see how the new layout performs, and I am very excited to see a unified cross-platform layout such as this being released.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;You probably know already about &lt;a href=&quot;http://www.engadget.com/2013/03/07/facebook-freshens-up-news-feed/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;the redesign Facebook will be carrying out to their News Feed&lt;/a&gt;. After reading some articles covering their presentation, there are lots of mentions to ‚Äúclutter reduction‚Äù, ‚Äúmore space for pictures‚Äù, ‚Äúmore info about check-ins‚Äù, etc. What I personally think is that Facebook has decided, simply, to unify their layout across devices. &lt;img src=&quot;/assets/images/posts/facebook-news-feed.jpg&quot; alt=&quot;Facebook News Feed Update&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
      <category term="cross-platform" scheme="https://jmperezperez.com/tags/cross-platform/"/>
    
  </entry>
  
  <entry>
    <title>Facebook for iOS: From HTML5 to native</title>
    <link href="https://jmperezperez.com/facebook-ios-html5-native/"/>
    <id>https://jmperezperez.com/facebook-ios-html5-native/</id>
    <published>2012-08-26T08:07:43.000Z</published>
    <updated>2019-10-31T22:46:22.867Z</updated>
    
    <content type="html"><![CDATA[<p>This week Facebook <a href="http://web.archive.org/web/20121019162440/http://newsroom.fb.com/News/A-Faster-Facebook-for-iOS-1b4.aspx" target="_blank" rel="noopener">announced an update for their iOS app</a> whose main change is a faster overall experience. Going deeper into technical details, we have ‚Äú<a href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-rebuilding-facebook-for-ios/10151036091753920" target="_blank" rel="noopener">Under the hood: Rebuilding Facebook for iOS</a>‚Äú, a nice post explaining what changes have been done.</p><a id="more"></a><h2 id="Lessons-learned-from-HTML5"><a href="#Lessons-learned-from-HTML5" class="headerlink" title="Lessons learned from HTML5"></a>Lessons learned from HTML5</h2><p>I really recommend reading ‚Äú<a href="http://readwrite.com/2011/12/27/redux_how_facebook_mobile_was_designed_to_write_once_run/" target="_blank" rel="noopener">How Facebook Mobile Was Designed to Write Once, Run Everywhere</a>‚Äú since it provides a better understanding about how Facebook mobile development has evolved. They found HTML5 to be the answer to share code between their mobile site and iOS app, developed as a hybrid app. After their experience on iOS, they decided to do the same with their Android app:</p><blockquote><p>But, this worked well enough that we said we are going to put the Android app on this party train too. So, we were actually able to write something like the m.site news feed once. Any time you change a news feed story or add a news feed story or add commenting and Liking or whatever, that is going to show up on low-end m.site, high-end m.site, Facebook for iPhone and Facebook for Android the very next day, or whenever we push, which is actually pretty awesome. - Dan Rowinski</p></blockquote><p>This also worked for their iPad app, which was basically the iPhone app with a chat column on landscape mode. Relying on apps that were the glue between the hardware and a webview, made it possible to release minor changes often without the need of releasing a whole app update. So, even though now they have moved to a more native app, they still have provided ways to perform small changes transparently:</p><blockquote><p>[‚Ä¶] news feed is constantly evolving, and building more in Objective-C creates new challenges when we add in new features. To solve this, we came up with a different plan to let you use the newest features without requiring you to update the entire app: a ‚Äúfallback‚Äù renderer. - <a href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-rebuilding-facebook-for-ios/10151036091753920" target="_blank" rel="noopener">Jonathan Dann</a></p></blockquote><p>and they will still be using HTML5 in certain parts:</p><blockquote><p>For areas within the app where we anticipate making changes more often, we will continue to utilize HTML5 code, as we can push updates server side without requiring people to download a new version of the app. - <a href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-rebuilding-facebook-for-ios/10151036091753920" target="_blank" rel="noopener">Jonathan Dann</a></p></blockquote><p>In fact Facebook has always defended HTML5 in order to circumvent application stores approval processes and offer a more unified experience across devices, with projects such as <a href="http://techcrunch.com/2011/06/15/facebook-project-spartan/" target="_blank" rel="noopener">Spartan</a>, and pushing to create a benchmark showing mobile browsers capabilities with <a href="https://developers.facebook.com/blog/post/2012/02/27/announcing-ringmark--a-mobile-browser-test-suite/" target="_blank" rel="noopener">Ringmark</a>.</p><h2 id="Rewriting-the-app-from-HTML5-to-native-code"><a href="#Rewriting-the-app-from-HTML5-to-native-code" class="headerlink" title="Rewriting the app from HTML5 to native code"></a>Rewriting the app from HTML5 to native code</h2><p>Facebook‚Äôs decision is similar to the one <a href="/developing-mobile-webapp-first/">using web technologies</a> in those stages where changes are frequent is a nice idea. Once they knew how they wanted their app to look like and were confident enough, they moved to native, to offer a better user experience to user‚Äôs of a certain platform. Thus, HTML5 version is still available for many other platforms, both as a website and as hybrid apps (for instance, iOS lower than 4.3) and is doing the job well.</p><p>A hybrid app can‚Äôt offer the same performance as a native app. This is a matter of taking into consideration the pros and cons in terms of code reuse and best experience in every platform. Web implementations run on top of an additional layer, so native code is more likely to have a better performance to achieve the same result. That is why projects such as <a href="/boot-to-gecko-html5/">Boot to Gecko</a> pretend to set an environment that exposes access to native hardware using Javascript.</p><p>There is an ongoing discussion about a deliberately decision from Apple and Google on <a href="https://web.archive.org/web/20150516201644/http://branch.com/b/a-blow-to-html5" target="_blank" rel="noopener">not making more efforts on improving Javascript performance on hybrid apps</a>. Though it could make sense, I‚Äôd rather think this is not the case.</p>]]></content>
    
    <summary type="html">
    
      Facebook has rewritten their iOS app from HTML5 to native code to provide a faster user experience. Having actively promoted HTML5 development, this shows hybrid apps performance is still not good enough, but some ideas can be taken from this decision.
    
    </summary>
    
    
      <category term="html5" scheme="https://jmperezperez.com/tags/html5/"/>
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
      <category term="hybrid apps" scheme="https://jmperezperez.com/tags/hybrid-apps/"/>
    
  </entry>
  
  <entry>
    <title>Avoid showing address bar on iPhone when loading ajax</title>
    <link href="https://jmperezperez.com/prevent-iphone-navigation-bar-ajax-link-click/"/>
    <id>https://jmperezperez.com/prevent-iphone-navigation-bar-ajax-link-click/</id>
    <published>2011-06-11T16:28:08.000Z</published>
    <updated>2019-10-31T22:46:22.865Z</updated>
    
    <content type="html"><![CDATA[<p>You can find a <a href="/demos/iphone-links"><strong>demo</strong> showing the default behaviour and the one using Facebook‚Äôs technique</a>. Use an iPhone or iPod Touch to see the effect.</p><p>When clicking a link for ajax navigation on iPhone and iPod Touch, the navigation bar slides down and up for every link, even when they are enhanced to support ajax navigation and its click event is captured and we load content using XMLHttpRequest instead.</p><a id="more"></a><p>This is a bit annoying and some developers have already tried to solve it. See these links:</p><ul><li><p><a href="http://stackoverflow.com/questions/1788605/can-iphone-safari-be-prevented-from-showing-the-navigation-bar-during-an-ajax-cal" target="_blank" rel="noopener">Can iPhone Safari be prevented from showing the navigation bar during an AJAX call?</a></p></li><li><p><a href="https://forum.jquery.com/topic/ios-urlbar-shows-then-hides-when-clicking-internal-link" target="_blank" rel="noopener">iOS urlbar shows then hides when clicking internal link</a></p></li><li><p><a href="https://forum.jquery.com/topic/stopping-the-url-bar-from-dropping-down-i-discovered-a-workaround" target="_blank" rel="noopener">Stopping the url bar from dropping down - I discovered a workaround</a></p></li><li><p><a href="http://forum.jquery.com/topic/how-do-i-stop-mobile-safari-from-dropping-down-its-url-loading-bar-whenever-i-submit-an-ajax-request" target="_blank" rel="noopener">How do i stop mobile safari from dropping down its URL/Loading bar whenever i submit an ajax request?</a></p></li></ul><p>The fact of having an anchor with an href attribute is enough for Safari Mobile to show the bar unless the address is preceded by the hash sign. It is not the fact of changing the URL, because if you preventDefault() the click on the link and avoid the navigation, the bar is shown anyway.</p><p>I realized that Facebook, among others sites with iPhone adapted versions (see jQtouch, Sencha Touch or Twitter), didn‚Äôt show that bar dropping from the top of the screen.</p><p>Looking at Facebook‚Äôs mobile site code, I found out that they made a workaround. They attach to the touchend event, which is fired before the click event fires, and then replace the value of the href attribute:</p><pre class=" language-js"><code class="language-js">JX<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token string">"MLinkHack"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>initialize<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>JX<span class="token punctuation">.</span>MTouchClick<span class="token punctuation">.</span><span class="token function">hasTouchEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  JX<span class="token punctuation">.</span>Stratcom<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">"touchend"</span><span class="token punctuation">,</span> <span class="token string">"tag:a"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> c <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token string">"tag:a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"target"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"_blank"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>b <span class="token operator">||</span> b<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> d <span class="token operator">=</span> JX<span class="token punctuation">.</span><span class="token function">$U</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>d <span class="token operator">&amp;&amp;</span> d <span class="token operator">!==</span> <span class="token string">"http"</span> <span class="token operator">&amp;&amp;</span> d <span class="token operator">!==</span> <span class="token string">"https"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    JX<span class="token punctuation">.</span>MLinkHack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> statics<span class="token punctuation">:</span><span class="token punctuation">{</span>_hack<span class="token punctuation">:</span><span class="token string">"#!"</span><span class="token punctuation">,</span> add<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">,</span> JX<span class="token punctuation">.</span>MLinkHack<span class="token punctuation">.</span>_hack <span class="token operator">+</span> a<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> remove<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  a <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>JX<span class="token punctuation">.</span>MLinkHack<span class="token punctuation">.</span>_hack<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> a<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> a<span class="token punctuation">;</span>
  b<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Later, the href value is set back to its original value, calling to the <code>JX.MLinkHack.remove()</code> method:</p><pre class=" language-js"><code class="language-js">JX<span class="token punctuation">.</span><span class="token function">behavior</span><span class="token punctuation">(</span><span class="token string">"m-link"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  JX<span class="token punctuation">.</span>Stratcom<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"tag:a"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>JX<span class="token punctuation">.</span>Stratcom<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> e <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getRawEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> link <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token string">"tag:a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"onclick"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>which <span class="token operator">||</span> e<span class="token punctuation">.</span>button<span class="token punctuation">)</span> <span class="token operator">&amp;</span>gt<span class="token punctuation">;</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>FW_BFF_ENABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FWBff<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"/fb/onclick"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>link<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> link<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"target"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>user_action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">user_action</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      JX<span class="token punctuation">.</span>MLinkHack<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> href <span class="token operator">=</span> link<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>As we see, this is only done for touch devices. Non-touch devices see normal links, so we can provide the default navigation for the rest of devices. That is nice for our progressive enhancement approach.</p><p>This workaround works nice when applied to a hash based ajax navigation. In addition, if we want to use History API, then we could call <code>history.pushState()</code> in the click event, once we have replaced the href to its original value. That way we would use the hash as a temporary hack to prevent Safari browser from showing the bar. Have a look at this snippet:</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//hide bar on page load</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//attach event touchend</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    <span class="token string">'touchend'</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>nodeName <span class="token operator">!==</span> <span class="token string">'A'</span> <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">.</span>nodeName <span class="token operator">!==</span> <span class="token string">'BODY'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            target <span class="token operator">=</span> target<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'A'</span> <span class="token operator">&amp;&amp;</span>
            target<span class="token punctuation">.</span>className <span class="token operator">===</span> <span class="token string">'facebook'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'#!'</span> <span class="token operator">+</span> target<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//attach event click</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    <span class="token string">'click'</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>className <span class="token operator">===</span> <span class="token string">'prevent'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>className <span class="token operator">===</span> <span class="token string">'facebook'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> href <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#!'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> newHref <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href <span class="token operator">=</span> newHref<span class="token punctuation">;</span>
                    location<span class="token punctuation">.</span>hash <span class="token operator">=</span> newHref<span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>I will try to check the techniques that other sites have implemented to solve this, but they might be similar to this one.</p><p>And I find this less hacky than using a ‚Äòlink‚Äô attribute instead of ‚Äòhref‚Äô attribute in anchors, or replace anchors by buttons, as I have read somewhere.</p><p>Want to see it in action? <a href="/demos/iphone-links"><strong>See the demo</strong></a>.</p>]]></content>
    
    <summary type="html">
    
      Workaround to avoid showing the loading address bar when loading ajax content on iPhone.
    
    </summary>
    
    
      <category term="ios" scheme="https://jmperezperez.com/tags/ios/"/>
    
      <category term="javascript" scheme="https://jmperezperez.com/tags/javascript/"/>
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
      <category term="ajax" scheme="https://jmperezperez.com/tags/ajax/"/>
    
      <category term="mobile" scheme="https://jmperezperez.com/tags/mobile/"/>
    
  </entry>
  
  <entry>
    <title>Front End Tech Talk - Facebook</title>
    <link href="https://jmperezperez.com/facebook-frontend-javascript/"/>
    <id>https://jmperezperez.com/facebook-frontend-javascript/</id>
    <published>2011-01-30T16:29:22.000Z</published>
    <updated>2019-10-31T22:46:22.865Z</updated>
    
    <content type="html"><![CDATA[<p>Yesterday I watched this <a href="http://www.facebook.com/video/video.php?v=596368660334" target="_blank" rel="noopener">Front End Tech Talk by Facebook</a>. I found it very interesting because they explained how they faced the problem of having a lot of javascript code and how they managed to reduce it. I think this can be applied not only to a website of the size of Facebook‚Äôs, but also any other project where we could refactor existing code.</p><blockquote><p>We had about 1MB of JS on the homepage</p></blockquote><p>They realized they had a problem with so much JS code and they worked at different levels to shrink it. <a href="/assets/images/posts/facebook-1mb-javascript.jpg"><img src="/assets/images/posts/facebook-1mb-javascript-1024x574.jpg" alt="We had about of 1MB of JS on the homepage"></a></p><a id="more"></a><h2 id="Haste"><a href="#Haste" class="headerlink" title="Haste"></a>Haste</h2><p>Haste is a package and dependency manager for CSS and JS files. In each file they specify the name of the package provided by the file and those files that are required to run the file. Thus, Haste can manage what files are needed to run a certain script.</p><p>This helps managing how files are requested and even which sets of files should be merged. This system was further explained by <a href="https://www.linkedin.com/in/davidwei79/" target="_blank" rel="noopener">Xiaoliang ‚ÄúDavid‚Äù Wei</a> at his talk about <a href="http://velocity.oreilly.com.cn/2010/ppts/VelocityChina2010Dec7StaticResource.pdf" target="_blank" rel="noopener"><em>Static resource management &amp; optimization</em></a> that took place on December 2010 at Velocity China.</p><h2 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a>Bootloader</h2><p>Bootloader consists of a JS library that helps loading and unloading static resources on demand. Not too far of RequireJS or LabJS. It uses dynamic script injection and executes a callback function once the resource is loaded.</p><p>The good point is that you can even suggest static resources that are not immediately needed but could be prefetched at background.</p><h2 id="Primer"><a href="#Primer" class="headerlink" title="Primer"></a>Primer</h2><p>Makinde Adeagbo <a href="http://jsconf.blip.tv/file/3839676/" target="_blank" rel="noopener">already talked about Primer at JSConf 2010</a> (<a href="http://www.slideshare.net/makinde/javascript-primer" target="_blank" rel="noopener">slides</a>).</p><p>A waterfall analysis showed that CSS resources where requested quite at the bottom and a lot of javascript on the head. Moving Javascript code to the bottom showed that the user interface would freeze while downloading/parsing/executing this code and that would provide a bad user experience. In some way, this is quite similar to what Yahoo! also found out, and I explained on my <em><a href="/yahoo-tips-website-performance-flush-bottom/">The not so good performance tips</a></em> post.</p><p>They decided to rewrite their JS code so that they could load a small file at the top that would provide the common functionality needed (about 80% of the interactions). And they moved Javascript client code to PHP code on the server. Instead of calling to a function like this one: <a href="/assets/images/posts/prev-dialog-code.jpg"><img src="/assets/images/posts/prev-dialog-code-1024x574.jpg" alt="Before Primer"></a> <em>Javascript code to build a dialog</em></p><p>they rewrote dialogs as anchors with a rel=‚Äùdialog‚Äù attribute: <a href="/assets/images/posts/after-dialog-code.jpg"><img src="/assets/images/posts/after-dialog-code-1024x574.jpg" alt="Dialog link using Primer"></a> <em>Simplified code to mark a link as a dialog</em></p><p>Basically they embraced progressive enhancement. This dialog links would be ajaxified later using a common Javascript code: <a href="/assets/images/posts/after-dialog-code-common.jpg"><img src="/assets/images/posts/after-dialog-code-common-1024x573.jpg" alt="Adding dialog behavior using Javascript"></a> <em>Adding a listener to manage click events on links marked as dialogs</em></p><p>And instead of letting Javascript set the title, content and the rest of dialog properties, it is the server the one that serves the dialog formatted as needed. <a href="/assets/images/posts/dialog-server-code.jpg"><img src="/assets/images/posts/dialog-server-code-1024x574.jpg" alt="PHP code to generate a dialog"></a> <em>PHP chainable code to create a dialog and set different properties</em></p><p>It is like converting a jQuery widget plugin into an ajax call and let the server generate the widget content.</p><p>They used this same approach to replace chunks of similar Javascript code. In async calls that retrieved html to replace existing markup, they are now generating javascript code (using PHP) on the server side and executing it in the async response. And if the url that should be requested when clicking an ajaxified link is a different one, they specify it using a custom <code>ajaxify</code> attribute. They also use this <code>ajaxify</code> attribute to specify that a form should be ajaxified.</p><p>Like Makindo says,</p><blockquote><p>if you are writing a site with tons and tons of Javascript it is very easy to forget about actual forms</p></blockquote><p>All this common interactions are shown in the comments form: <a href="/assets/images/posts/application-comment-form.jpg"><img src="/assets/images/posts/application-comment-form-1024x573.jpg" alt="Facebook&#39;s comment form"></a> <em>An example of common interactions that in their comment form</em></p><p>The top red arrow indicates that Comment is a label, so clicking on it focuses the comment textarea.</p><p>Some sample Javascript code is available on <a href="https://gist.github.com/376039" target="_blank" rel="noopener">https://gist.github.com/376039</a>.</p><p>They managed to not only reduce Javascript size, but loading CSS on the top and being able to load Javascript at the bottom in an async mode.</p><p>This talk shows that sometimes it is necessary to return to the basic elements and build interactions from there, trying to find common functionality to reduce the code needed, and embracing progressive enhancement as a way to achieve it.</p>]]></content>
    
    <summary type="html">
    
      Nice ideas taken from Facebook&#39;s Front End Tech Talk about implementing common interactions and patterns to reduce Javascript file size and use progressive enhancement.
    
    </summary>
    
    
      <category term="javascript" scheme="https://jmperezperez.com/tags/javascript/"/>
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
      <category term="bootloader" scheme="https://jmperezperez.com/tags/bootloader/"/>
    
      <category term="frontend" scheme="https://jmperezperez.com/tags/frontend/"/>
    
      <category term="haste" scheme="https://jmperezperez.com/tags/haste/"/>
    
      <category term="primer" scheme="https://jmperezperez.com/tags/primer/"/>
    
  </entry>
  
  <entry>
    <title>Updates on BigPipe using ASP.NET MVC</title>
    <link href="https://jmperezperez.com/updates-on-bigpipe-using-asp-net-mvc/"/>
    <id>https://jmperezperez.com/updates-on-bigpipe-using-asp-net-mvc/</id>
    <published>2010-12-11T16:17:14.000Z</published>
    <updated>2019-10-31T22:46:22.864Z</updated>
    
    <content type="html"><![CDATA[<p>It‚Äôs been several weeks since I wrote <a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1">a tutorial to implement BigPipe using C# and ASP.Net MVC</a>. And I have just read <a href="http://velocity.oreilly.com.cn/index.php?func=session&amp;name=Facebook%E7%BD%91%E7%AB%99%E7%9A%84Ajax%E5%8C%96%E3%80%81%E7%BC%93%E5%AD%98%E5%92%8C%E6%B5%81%E6%B0%B4%E7%BA%BF" target="_blank" rel="noopener">a PDF from a presentation at Velocity China</a> in which Changhao Jiang, from Facebook, explains some details about Bigpipe, as well as other techniques they use to improve Time to interact (both real and perceived), as well as data savings. These techniques (named Quickling and PageCache) are based on hijax and an intelligent update of specific content of the page instead of the whole page when data changes.</p><a id="more"></a><p>According to Changhao Jiang, this is the improvement when using BigPipe on Facebook: <img src="/assets/images/posts/bigpipe-tti-improvement-e1320910397828.png" alt="Improvement when using BigPipe on Facebook"></p><p>My first project using BigPipe as I explained is about to go online. Overall I can say that BigPipe approach has helped divide pages into independent chunks using RenderAction, opposite to overpopulating a single action to retrieve all data needed by the page. And I have faced some problems involving pagelet content.</p><p>##HTML to JSON When using JavascriptSerializer (or JsonResult) to convert HTML content to JSON, the generated code is not as nice as Facebook‚Äôs.</p><p>While yours will look similar to</p><pre class=" language-js"><code class="language-js">bigpipe<span class="token punctuation">.</span><span class="token function">onPageletArrive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"Id"</span><span class="token punctuation">:</span><span class="token string">"my-pagelet"</span><span class="token punctuation">,</span><span class="token string">"Content"</span><span class="token punctuation">:</span>"\\r\n\r\n\u003cdiv <span class="token keyword">class</span><span class="token operator">=</span>\"my<span class="token operator">-</span>div\"\u003e\r\n    \u003c <span class="token operator">...</span>
</code></pre><p>Facebook‚Äôs is more like this:</p><pre class=" language-js"><code class="language-js">bigpipe<span class="token punctuation">.</span><span class="token function">onPageletArrive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"Id"</span><span class="token punctuation">:</span><span class="token string">"my-pagelet"</span><span class="token punctuation">,</span><span class="token string">"Content"</span><span class="token punctuation">:</span>"<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span>\"my<span class="token operator">-</span>div\"<span class="token operator">></span> <span class="token operator">...</span>
</code></pre><p>So (1) it can be a good idea to strip whitespace from your code and (2) maybe you would like to replace those \u003c and \u003e (see <a href="http://stackoverflow.com/questions/1058895/cant-get-to-show-up-in-json-string" target="_blank" rel="noopener">this discussion at stackoverflow</a> and <a href="http://forums.asp.net/t/1440943.aspx" target="_blank" rel="noopener">this other link</a>).</p><p>##Javascript code not being executed when appended to document using ajax If your pagelet contains Javascript code, you‚Äôd better off moving it from the content of the pagelet to a javascript file to be downloaded and executed as I explain in the tutorial. When you append the content of the pagelet to the container, its Javascript code will not be executed, so take this into account.</p><p>In the next days I will update the code of the tutorial to include minor changes that I have found can improve it. And when I have more information about how my little bigpipe is performing I will write a post about it.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;It‚Äôs been several weeks since I wrote &lt;a href=&quot;/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1&quot;&gt;a tutorial to implement BigPipe using C# and ASP.Net MVC&lt;/a&gt;. And I have just read &lt;a href=&quot;http://velocity.oreilly.com.cn/index.php?func=session&amp;amp;name=Facebook%E7%BD%91%E7%AB%99%E7%9A%84Ajax%E5%8C%96%E3%80%81%E7%BC%93%E5%AD%98%E5%92%8C%E6%B5%81%E6%B0%B4%E7%BA%BF&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a PDF from a presentation at Velocity China&lt;/a&gt; in which Changhao Jiang, from Facebook, explains some details about Bigpipe, as well as other techniques they use to improve Time to interact (both real and perceived), as well as data savings. These techniques (named Quickling and PageCache) are based on hijax and an intelligent update of specific content of the page instead of the whole page when data changes.&lt;/p&gt;
    
    </summary>
    
    
      <category term="performance" scheme="https://jmperezperez.com/tags/performance/"/>
    
      <category term="bigpipe" scheme="https://jmperezperez.com/tags/bigpipe/"/>
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
  </entry>
  
  <entry>
    <title>Tutorial: Implementing Facebook&#39;s BigPipe Using ASP.Net MVC - Part 3</title>
    <link href="https://jmperezperez.com/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3/"/>
    <id>https://jmperezperez.com/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3/</id>
    <published>2010-09-27T17:25:11.000Z</published>
    <updated>2019-10-31T22:46:22.864Z</updated>
    
    <content type="html"><![CDATA[<p>Parts of the tutorial</p><ol><li><a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1">Introduction to BigPipe</a></li><li><a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-2">How ASP.Net MVC fits in the model. Registering and generating pagelets</a></li><li>Browser implementation of BigPipe. Loading pagelets and their resources effectively</li><li><a href="https://github.com/JMPerez/BigPipe" target="_blank" rel="noopener">Check out the demo Visual Studio solution</a></li></ol><p>In this third part of the tutorial to carry out a technique similar to BigPipe I will cover the browser side. BigPipe is not only focused on server side, but it also sets how the different resources that our pagelets need have to be requested and loaded in the document.</p><a id="more"></a><h2 id="Registering-a-pagelet-and-its-resources"><a href="#Registering-a-pagelet-and-its-resources" class="headerlink" title="Registering a pagelet and its resources"></a>Registering a pagelet and its resources</h2><p>In the Pagelet class I will declare a constructor that accepts a list of CSS files and a list of JavaScript files needed by the pagelet:</p><pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token function">Pagelet</span><span class="token punctuation">(</span><span class="token keyword">string</span> container<span class="token punctuation">,</span> Func<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> action<span class="token punctuation">,</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> css<span class="token punctuation">,</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> js<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Container <span class="token operator">=</span> container<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Action <span class="token operator">=</span> action<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Id <span class="token operator">=</span> container<span class="token punctuation">,</span>
        Css <span class="token operator">=</span> css<span class="token punctuation">,</span>
        Js <span class="token operator">=</span> js
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>In my sample code I am registering two pagelets in the View:</p><pre class=" language-csharp"><code class="language-csharp"><span class="token operator">&lt;</span><span class="token operator">%</span>  HttpRequest req <span class="token operator">=</span> HttpContext<span class="token punctuation">.</span>Current<span class="token punctuation">.</span>Request<span class="token punctuation">;</span>
    Html<span class="token punctuation">.</span><span class="token function">RegisterPagelet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pagelet</span><span class="token punctuation">(</span>
        <span class="token string">"pagelet1-pagelet"</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Html<span class="token punctuation">.</span><span class="token function">RenderActionToString</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token string">"home"</span><span class="token punctuation">,</span> <span class="token string">"pagelet1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"../../Content/Pagelet1.css"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"</span><span class="token punctuation">,</span>
                <span class="token string">"../../Scripts/Pagelet1.js"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">&lt;</span><span class="token operator">%</span> Html<span class="token punctuation">.</span><span class="token function">RegisterPagelet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pagelet</span><span class="token punctuation">(</span>
    <span class="token string">"pagelet2-pagelet"</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Html<span class="token punctuation">.</span><span class="token function">RenderActionToString</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token string">"home"</span><span class="token punctuation">,</span> <span class="token string">"pagelet2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">"../../Content/Pagelet2.css"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">null</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>
</code></pre><p>As I said before, <code>Html.Action()</code> method can be used to store the result of an action in a string. However, it may throw exception if you use multi-threading to execute the different pagelets since it doesn‚Äôt keep a reference to original request. In fact, we are storing the current request in the <code>req</code> variable to avoid this exception when using <code>Html.RenderActionToString</code>. If you‚Äôd rather use a single-threaded <code>for</code> to go through the pagelets in the <code>ExecutePagelets</code> method (i.e. if you see that parallel <code>for</code> implies too much overload), then go for the <code>Action</code> method.</p><h2 id="Facebook‚Äôs-approach"><a href="#Facebook‚Äôs-approach" class="headerlink" title="Facebook‚Äôs approach"></a>Facebook‚Äôs approach</h2><p>In this tutorial I am implementing a simple solution covering BigPipe principles from server to browser. However, Facebook‚Äôs implementation is far more complex, taking into account resource dependencies and events. If we have a look at a sample call to their <code>onPageletArrive</code> Javascript function, we can see that they pass a JSON object similar to this one:</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"id"</span><span class="token operator">:</span> "<span class="token punctuation">,</span>
    <span class="token property">"phase"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token property">"is_last"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"append"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"bootloadable"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"css"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"MPQqY"</span><span class="token punctuation">,</span>
        <span class="token string">"uwtW6"</span><span class="token punctuation">,</span>
        <span class="token string">"wWhUT"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"js"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"RpPeo"</span><span class="token punctuation">,</span>
        <span class="token string">"C9ueD"</span><span class="token punctuation">,</span>
        <span class="token string">"q+PxV"</span><span class="token punctuation">,</span>
        <span class="token string">"Ok1Y0"</span><span class="token punctuation">,</span>
        <span class="token string">"dOwRG"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"resource_map"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"requires"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"provides"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"onload"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"onafterload"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"onpagecache"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"onafterpagecache"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"refresh_pagelets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"invalidate_cache"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"page_cache"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><p>From there, we will cover <code>id</code>, <code>css</code>, <code>js</code> and <code>content</code> fields. Most of the rest of fields are self-explainable, and they could be implemented easily on our basic BigPipe implementation.</p><h2 id="Javascript-detection"><a href="#Javascript-detection" class="headerlink" title="Javascript detection"></a>Javascript detection</h2><p>We will detect Javascript using a cookie that will be written using Javascript. The first request to our page will not send that cookie, so we will serve a non-BigPipe version. I prefer this to making a redirection to the same page if Javascript is enabled.</p><p>In the Site.Master, just before ending body tag we can add the Javascript detection code:</p><pre class=" language-csharp"><code class="language-csharp">    <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Request<span class="token punctuation">.</span>Cookies<span class="token punctuation">[</span><span class="token string">"js"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">var</span> exdate<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exdate<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span>exdate<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">"js=true;expires="</span> <span class="token operator">+</span> exdate<span class="token punctuation">.</span><span class="token function">toUTCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">></span>
</code></pre><h2 id="Loading-CSS-and-JS"><a href="#Loading-CSS-and-JS" class="headerlink" title="Loading CSS and JS"></a>Loading CSS and JS</h2><p>We will need a basic Javascript script that allows us:</p><ul><li>Load in parallel the set of CSS resources needed by each pagelet</li><li>Append the HTML code of a pagelet inside its container</li><li>Request in parallel all the Javascript files needed by the set of pagelets, once they all have been appended to the document, and execute them</li></ul><p>Moreover, the size of the script has to be as small as possible, since it will be a blocking script.</p><pre class=" language-js"><code class="language-js"> <span class="token keyword">var</span> Loader <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">var</span> d <span class="token operator">=</span> document<span class="token punctuation">,</span>
         head <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"head"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

     <span class="token keyword">var</span> loadJs <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">var</span> script <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
         script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token keyword">var</span> loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         <span class="token keyword">var</span> loadFunction <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
             loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
             cb <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">;</span>
         script<span class="token punctuation">.</span>onload <span class="token operator">=</span> loadFunction<span class="token punctuation">;</span>
         script<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> loadFunction<span class="token punctuation">;</span>
         head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">;</span>

     <span class="token keyword">var</span> cachedBrowser<span class="token punctuation">;</span>

     <span class="token keyword">var</span> browser <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">var</span> ua <span class="token operator">=</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">var</span> match <span class="token operator">=</span> <span class="token regex">/(webkit)[ \/]([\w.]+)/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>ua<span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token regex">/(opera)(?:.*version)?[ \/]([\w.]+)/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>ua<span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token regex">/(msie) ([\w.]+)/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>ua<span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token operator">!</span><span class="token regex">/compatible/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>ua<span class="token punctuation">)</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> <span class="token regex">/(mozilla)(?:.*? rv:([\w.]+))?/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>ua<span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
             cachedBrowser <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> cachedBrowser<span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">;</span>

     <span class="token keyword">var</span> loadCss <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">var</span> link <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"link"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         link<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">"text/css"</span><span class="token punctuation">;</span>
         link<span class="token punctuation">.</span>rel <span class="token operator">=</span> <span class="token string">"stylesheet"</span><span class="token punctuation">;</span>
         link<span class="token punctuation">.</span>href <span class="token operator">=</span> url<span class="token punctuation">;</span>

         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">browser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"msie"</span><span class="token punctuation">)</span>
             link<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token regex">/loaded|complete/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">browser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"opera"</span><span class="token punctuation">)</span>
             link<span class="token punctuation">.</span>onload <span class="token operator">=</span> cb<span class="token punctuation">;</span>
         <span class="token keyword">else</span>
         <span class="token comment" spellcheck="true">//FF, Safari, Chrome</span>
             <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token keyword">try</span> <span class="token punctuation">{</span>
                     link<span class="token punctuation">.</span>sheet<span class="token punctuation">.</span>cssRule<span class="token punctuation">;</span>
                 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token function">setTimeout</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>callee<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">return</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span><span class="token punctuation">;</span>
                 <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">;</span>

     <span class="token keyword">return</span> <span class="token punctuation">{</span> loadCss<span class="token punctuation">:</span> loadCss<span class="token punctuation">,</span> loadJs<span class="token punctuation">:</span> loadJs <span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">function</span> <span class="token function">PageLet</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> domInserted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">var</span> data <span class="token operator">=</span> p<span class="token punctuation">,</span>
        remainingCss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

     <span class="token keyword">var</span> loadCss <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">//load css</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>Css <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> data<span class="token punctuation">.</span>Css<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             remainingCss <span class="token operator">=</span> data<span class="token punctuation">.</span>Css<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
             <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> remainingCss<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
                 Loader<span class="token punctuation">.</span><span class="token function">loadCss</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Css<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token operator">!</span> <span class="token operator">--</span>remainingCss <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> <span class="token function">insertDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
             <span class="token function">insertDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword">var</span> insertDom <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> p<span class="token punctuation">.</span>Content<span class="token punctuation">;</span>
         <span class="token function">domInserted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword">var</span> loadJs <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>Js<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">//load js</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>Js<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
             Loader<span class="token punctuation">.</span><span class="token function">loadJs</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Js<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword">return</span> <span class="token punctuation">{</span> loadCss<span class="token punctuation">:</span> loadCss<span class="token punctuation">,</span> loadJs<span class="token punctuation">:</span> loadJs <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">var</span> BigPipe <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">var</span> d <span class="token operator">=</span> document<span class="token punctuation">,</span>
        pagelets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* registered pagelets */</span>

     <span class="token keyword">var</span> onPageletArrive <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         count <span class="token operator">=</span> count <span class="token operator">||</span> p<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
         <span class="token keyword">var</span> pagelet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageLet</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token operator">--</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token comment" spellcheck="true">//load js</span>
                 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pagelets<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                     pagelets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">loadJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         pagelets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pagelet<span class="token punctuation">)</span><span class="token punctuation">;</span>
         pagelet<span class="token punctuation">.</span><span class="token function">loadCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">;</span>

     <span class="token keyword">return</span> <span class="token punctuation">{</span> onPageletArrive<span class="token punctuation">:</span> onPageletArrive <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><p>Once minimized using Google Closure, the size is 1.27KB (666 bytes gzipped), so we have a very small script that fits our requirements.</p><h2 id="Resources-chart"><a href="#Resources-chart" class="headerlink" title="Resources chart"></a>Resources chart</h2><p>The following chart shows how resources are loaded: <img src="/assets/images/posts/bigpipe-02.jpg" alt="Resources loading graph using BigPipe"></p><p>We can see that the main document flushes early, starting the requests for Site.css and BigPipe.js, which are in the head section of our view. When pagelets are executed (I have set a Thread.Sleep in both pagelets) their CSS resources are requested and only after they have been appended to the document their Javascript resources are downloaded and executed.</p><h2 id="Further-improvements"><a href="#Further-improvements" class="headerlink" title="Further improvements"></a>Further improvements</h2><p>There are a lot of points that can be improved. I have thought of several of them, what could lead to a more complex solution that can provide BigPipe to ASP.Net MVC in a not so experimental way.</p><h3 id="Fire-event-before-starting-loading-js-for-pagelets"><a href="#Fire-event-before-starting-loading-js-for-pagelets" class="headerlink" title="Fire event before starting loading js for pagelets"></a>Fire event before starting loading js for pagelets</h3><p>Scripts that are needed by the page but do not need to be loaded before executing pagelets can be delayed and be requested when the pagelets‚Äô scripts are.</p><h3 id="Manage-dependencies-between-scripts"><a href="#Manage-dependencies-between-scripts" class="headerlink" title="Manage dependencies between scripts"></a>Manage dependencies between scripts</h3><p>As Facebook does, it can be a good idea to incorporate dependencies solving logic to request and execute JavaScript resources in the best order.</p><p>Avoid double insertion. If two pagelets require the same script, it is only necessary to request once.</p><h3 id="Manage-pagelets-resources-in-a-unique-place"><a href="#Manage-pagelets-resources-in-a-unique-place" class="headerlink" title="Manage pagelets resources in a unique place"></a>Manage pagelets resources in a unique place</h3><p>In my solution, pagelets‚Äô resources are specified in the view that is including them. If we decide to change the implementation of a pagelet and now we need a different set of resources (i.e. an extra JS resource)</p><h2 id="Drawbacks-of-this-implementation"><a href="#Drawbacks-of-this-implementation" class="headerlink" title="Drawbacks of this implementation"></a>Drawbacks of this implementation</h2><p>At first I see a performance problem when the browser does not support Javascript. As we are registering pagelets as PartialViews rendered inside the body ContentPlaceHolder, we have no way to include CSS resources back to the head section, since it has already been generated. So we have to include the CSS link elements inside the body, blocking renderization.</p><p>The good thing is that we save bytes not writing script elements when we detect the browser has JavaScript disabled.</p>]]></content>
    
    <summary type="html">
    
      Last part of my tutorial on Implementing BigPipe, focused on browser side, loading CSS and JS resources efficiently using a small script.
    
    </summary>
    
    
      <category term="asp net mvc" scheme="https://jmperezperez.com/tags/asp-net-mvc/"/>
    
      <category term="bigpipe" scheme="https://jmperezperez.com/tags/bigpipe/"/>
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
  </entry>
  
  <entry>
    <title>Tutorial: Implementing Facebook&#39;s BigPipe Using ASP.Net MVC - Part 2</title>
    <link href="https://jmperezperez.com/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-2/"/>
    <id>https://jmperezperez.com/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-2/</id>
    <published>2010-09-22T17:34:36.000Z</published>
    <updated>2019-10-31T22:46:22.864Z</updated>
    
    <content type="html"><![CDATA[<p>Parts of the tutorial</p><ol><li><a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1">Introduction to BigPipe</a></li><li>How ASP.Net MVC fits in the model. Registering and generating pagelets</li><li><a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3">Browser implementation of BigPipe. Loading pagelets and their resources effectively</a></li><li><a href="https://github.com/JMPerez/BigPipe" target="_blank" rel="noopener">Check out the demo Visual Studio solution</a></li></ol><p>In <a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1">the previous post of this tutorial</a> I made an overview explaining how Bigpipe works and why it can improve users‚Äô perceived speed when loading our pages.</p><a id="more"></a><p>Basically Bigpipe combines early flushing, parallel processing and a managed resources loading in the browser to prioritize showing content quickly over loading and executing JavaScript files.</p><p>In this second post I will show how ASP.Net MVC features fit in the BigPipe model. Code snippets will help to illustrate he different parts. I will upload the source code in a Visual Studio 2010 project during the next days, so you can download it and further explore this technique.</p><h2 id="View-structure"><a href="#View-structure" class="headerlink" title="View structure"></a>View structure</h2><p>Our view structure will be the usual when working with ASP.Net MVC:</p><ul><li><code>Site.Master</code>: Contains the skeleton of the HTML document. It will also fire the execution of the pagelets.</li><li><code>SomePage.aspx</code>: Fills the ContentPlaceHolders of the Site.Master. It will include the different pagelets.</li><li><code>Pagelet1.ascx</code>, <code>Pagelet2.ascx</code>‚Ä¶ : The partial views that provides content to some areas that compose the page.</li></ul><h2 id="Pagelets-as-RenderActions"><a href="#Pagelets-as-RenderActions" class="headerlink" title="Pagelets as RenderActions"></a>Pagelets as RenderActions</h2><p>Our pagelets will be included using RenderActions. Pagelets are supposed to take some time to be executed, so it makes sense that these will need to access data in some way. These data will be retrieved in a controller to keep MVC paradigm.</p><h2 id="Registering-pagelets"><a href="#Registering-pagelets" class="headerlink" title="Registering pagelets"></a>Registering pagelets</h2><p>First of all, we will declare a Pagelet class that is going to be used to register the Pagelets. A pagelet will contain an instance of Data, that will be serialized as JSON.</p><pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Data</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Content <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> Css <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> Js <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Pagelet</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> JavaScriptSerializer jss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaScriptSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Func<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> Action <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">readonly</span> <span class="token keyword">string</span> Container<span class="token punctuation">;</span>
    <span class="token keyword">public</span> Data Data <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// Manages a pagelet</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;param name=container>The id of the div container in which the output will be appended&lt;/param></span>
    <span class="token comment" spellcheck="true">/// &lt;param name=action>The action to execute that will generate the output&lt;/param></span>
    <span class="token keyword">public</span> <span class="token function">Pagelet</span><span class="token punctuation">(</span><span class="token keyword">string</span> container<span class="token punctuation">,</span> Func<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> action<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Container <span class="token operator">=</span> container<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Action <span class="token operator">=</span> action<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> container <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Content <span class="token operator">=</span> <span class="token function">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>script<span class="token operator">></span> <span class="token keyword">var</span> js_pagelet <span class="token operator">=</span>
            <span class="token operator">+</span> jss<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token punctuation">;</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>\
            <span class="token operator">+</span> Container
            <span class="token operator">+</span> \<span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> js_pagelet<span class="token punctuation">.</span>Content<span class="token punctuation">;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>The Js and Css arrays of strings will contain the files of these types needed by the pagelet to be styled and work correctly (in the next post I will make heavier use of these fields when covering the Javascript script).</p><p>The <code>Serialize()</code> method will generate the code to make the call to inject the code into its container.</p><p>Next, we will define some helpers that will be used to register the pagelet and store the output of the RenderAction call.</p><p>We want the rendered content to be converted into a JSON object so, instead of just rendering the action (writing the output directly to the response), we will render the action storing the result in a string. For this, we will use RenderActionToString.</p><p>We need a way to get the result of the RenderAction as a string. Following a similar method to the one used to <a href="http://www.klopfenstein.net/lorenz.aspx/render-partial-view-to-string-in-asp-net-mvc" target="_blank" rel="noopener">render a partial view to a string</a>, we can declare extension methods to get the output of an action:</p><pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RendererHelper</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// &lt;summary>Fake IView implementation, only used to instantiate an HtmlHelper.&lt;/summary></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FakeView</span> <span class="token punctuation">:</span> IView
    <span class="token punctuation">{</span>
        <span class="token preprocessor property">#<span class="token directive keyword">region</span> IView Members</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Render</span><span class="token punctuation">(</span>ViewContext viewContext<span class="token punctuation">,</span> System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>TextWriter writer<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotImplementedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">string</span> <span class="token function">RenderActionToString</span><span class="token punctuation">(</span><span class="token keyword">this</span> HtmlHelper helper<span class="token punctuation">,</span> HttpRequest request<span class="token punctuation">,</span> <span class="token keyword">string</span> controller<span class="token punctuation">,</span> <span class="token keyword">string</span> action<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//Create memory writer</span>
        <span class="token keyword">var</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> memWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//Create fake http context to render the view</span>
        <span class="token keyword">var</span> fakeResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">(</span>memWriter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> fakeContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpContext</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> fakeResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> fakeControllerContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ControllerContext</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">HttpContextWrapper</span><span class="token punctuation">(</span>fakeContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
            helper<span class="token punctuation">.</span>ViewContext<span class="token punctuation">.</span>RouteData<span class="token punctuation">,</span>
            helper<span class="token punctuation">.</span>ViewContext<span class="token punctuation">.</span>Controller<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> oldContext <span class="token operator">=</span> HttpContext<span class="token punctuation">.</span>Current<span class="token punctuation">;</span>
        HttpContext<span class="token punctuation">.</span>Current <span class="token operator">=</span> fakeContext<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//Use HtmlHelper to render partial view to fake context</span>
        <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HtmlHelper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ViewContext</span><span class="token punctuation">(</span>fakeControllerContext<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">FakeView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ViewDataDictionary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TempDataDictionary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memWriter<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ViewPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        html<span class="token punctuation">.</span><span class="token function">RenderAction</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> controller<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//Restore context</span>
        HttpContext<span class="token punctuation">.</span>Current <span class="token operator">=</span> oldContext<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//Flush memory and return output</span>
        memWriter<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>HtmlHelper already has the <code>Action</code> method extension that gets the result of an action in a string, but it can be problematic when using multiple threads to execute the pagelets, as I explain in the <a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3">third part of this tutorial</a>.</p><pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BigPipeHelper</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">RegisterPagelet</span><span class="token punctuation">(</span><span class="token keyword">this</span> HtmlHelper helper<span class="token punctuation">,</span> Pagelet pagelet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> context <span class="token operator">=</span> helper<span class="token punctuation">.</span>ViewContext<span class="token punctuation">.</span>HttpContext<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> jsEnabled <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Cookies<span class="token punctuation">[</span>js<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Cookies<span class="token punctuation">[</span>js<span class="token punctuation">]</span><span class="token punctuation">.</span>Value <span class="token operator">==</span> <span class="token keyword">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>jsEnabled<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//JavaScript is not enabled, so we write the execution to the output and</span>
            <span class="token comment" spellcheck="true">//not register the pagelet</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pagelet<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Css <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">string</span> css <span class="token keyword">in</span> pagelet<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Css<span class="token punctuation">)</span>
                    helper<span class="token punctuation">.</span><span class="token function">IncludeCss</span><span class="token punctuation">(</span>css<span class="token punctuation">)</span><span class="token punctuation">;</span>

            pagelet<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>div id<span class="token operator">=</span>\<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>\<span class="token operator">></span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">,</span> pagelet<span class="token punctuation">.</span>Container<span class="token punctuation">,</span> pagelet<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        List<span class="token operator">&lt;</span>Pagelet<span class="token operator">></span> pagelets <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Pagelet<span class="token operator">></span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Pagelets<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pagelets <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pagelets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Pagelet<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Pagelets<span class="token punctuation">]</span> <span class="token operator">=</span> pagelets<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pagelets<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>pagelet<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//write pagelet container</span>
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>div id<span class="token operator">=</span>\ <span class="token operator">+</span> pagelet<span class="token punctuation">.</span>Container <span class="token operator">+</span> \<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>We will use <a href="http://www.4guysfromrolla.com/articles/060904-1.aspx" target="_blank" rel="noopener">HttpContext.Items</a> to store the pagelets. The aspx page will decide to render each action or register a pagelet for later execution, depending on Javascript support. When using BigPipe we will choose the later one.</p><p>Then, in Site.Master, just before closing the body tag, we will make a flush so the browser can process the code generated so far, and then we will start executing the pagelets.</p><pre class=" language-html"><code class="language-html">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span> <span class="token attr-name">Response.Flush();</span> <span class="token attr-name">%</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span> <span class="token attr-name">Html.ExecutePagelets();</span> <span class="token attr-name">%</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
</code></pre><p>The pagelets will be executed in a set of parallel threads. Each thread will execute the render action and will write a Javascript call to process the pagelet. After writing this response, we will flush it so the browser can start processing the code for the just generated pagelet.</p><pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token keyword">object</span> _locker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ExecutePagelets</span><span class="token punctuation">(</span><span class="token keyword">this</span> HtmlHelper helper<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> context <span class="token operator">=</span> helper<span class="token punctuation">.</span>ViewContext<span class="token punctuation">.</span>HttpContext<span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>Pagelet<span class="token operator">></span> pagelets <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Pagelet<span class="token operator">></span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Pagelets<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pagelets <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    Parallel<span class="token punctuation">.</span><span class="token function">For</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pagelets<span class="token punctuation">.</span>Count<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> pagelet <span class="token operator">=</span> pagelets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        pagelet<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">lock</span><span class="token punctuation">(</span>_locker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>pagelet<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Parallel.For (C# 4.0) creates a set of threads and continues with the next instruction once they all have finished. For each pagelet, we store in the Content field the result of executing its Action() method, this is, the output of the RenderAction. Next we write to the output the Data object as a JSON string and flush it.</p><h3 id="Implementing-the-browser-side-of-Bigpipe"><a href="#Implementing-the-browser-side-of-Bigpipe" class="headerlink" title="Implementing the browser side of Bigpipe"></a>Implementing the browser side of Bigpipe</h3><p>I did not want to make just a proof of concept of Bigpipe, but also implement a basic system that covers this technique from the server to the browser.</p><p>In the next post I will focus on the script that will manage the loading of CSS and JavaScript resources for the pagelets. This script is independent of the technology and programming language used on server. I will also show some resources loading charts to see how BigPipe affects this.</p><p><strong>Update September 26th:</strong> I add a locker in the <code>ExecutePagelets</code> method to make response writing thread safe.</p><p><strong>Update September 27th:</strong> I add support for javascript disabled browser, generating content immediately when registering pagelets in <code>RegisterPagelet</code> method.</p>]]></content>
    
    <summary type="html">
    
      Build Facebook&#39;s BigPipe using C#. Source code to make pagelets and achieve delayed parallel execution in an ASP.Net MVC website.
    
    </summary>
    
    
      <category term="asp net mvc" scheme="https://jmperezperez.com/tags/asp-net-mvc/"/>
    
      <category term="bigpipe" scheme="https://jmperezperez.com/tags/bigpipe/"/>
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
  </entry>
  
  <entry>
    <title>Tutorial: Implementing Facebook&#39;s BigPipe Using ASP.Net MVC - Part 1</title>
    <link href="https://jmperezperez.com/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1/"/>
    <id>https://jmperezperez.com/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1/</id>
    <published>2010-09-18T07:37:07.000Z</published>
    <updated>2019-10-31T22:46:22.863Z</updated>
    
    <content type="html"><![CDATA[<p>Parts of the tutorial</p><ol><li>Introduction to BigPipe</li><li><a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-2">How ASP.Net MVC fits in the model. Registering and generating pagelets</a></li><li><a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3">Browser implementation of BigPipe. Loading pagelets and their resources effectively</a></li><li><a href="https://github.com/JMPerez/BigPipe" target="_blank" rel="noopener">Check out the demo Visual Studio solution</a></li></ol><p>Through a series of posts I will explain how we can implement BigPipe Facebook using ASP.Net MVC.</p><a id="more"></a><p>In this first post I will describe what BigPipe is and sketch how we can make a similar implementation using ASP.Net MVC.</p><p>You can clone the code from <a href="https://github.com/JMPerez/BigPipe" target="_blank" rel="noopener">the BigPipe project on GitHub</a> that includes all the source code needed to run the sample.</p><h2 id="What-is-BigPipe"><a href="#What-is-BigPipe" class="headerlink" title="What is BigPipe"></a>What is BigPipe</h2><p>BigPipe is a <a href="/techniques-optimize-web-sites">website performance technique</a> used and coined by Facebook to serve web pages improving user‚Äôs perceived load speed. In general, it consists of serving quickly the main content of the page, and then serve the content from other regions of the page called pagelets.</p><p>The implementation of these pagelets is performed in parallel on the server and served to the browser as soon as they are generated. This allows:</p><ol><li>Browser can start rendering the page content earlier (early flushing)</li><li>Pagelets are served as soon as they are ready and the browser can render them in their container.</li><li>If one pagelet takes longer to run, it will not delay the generation of the rest of pagelets.</li><li>Pagelets are generated in several concurrent asynchronous threads and when a thread finishes its execution, it flushes the content so the browser can start rendering.</li></ol><p>Sequence of the different stages during a pagelet generation:</p><p><img src="/assets/images/posts/bigpipe-sequence.svg" alt="Sequence of the different stages during a pagelet generation"></p><p>Apart from the pagelet generation, parallelism is also applied during the processing of the pagelet by the browser. Each pagelet can define a set of CSS and JS files that it needs to work properly. These files are requested in such a way that it keeps a good performance.</p><p>Graph showing how pagelets resources are requested:</p><p><img src="/assets/images/posts/bigpipe-pagelet-process.svg" alt="Graph showing how pagelets resources are requested"></p><ol><li>For each pagelet, request in parallel every necessary CSS resource</li><li>Once a pagelet has the necessary CSS files, inject the HTML code inside its container.</li><li>When every pagelet has finished request its CSS files and is inserted in the document, proceed to request in parallel the JS files needed by the whole set of pagelets.</li></ol><p>By keeping these steps we make sure that the pagelets are appended to the document and set their style, avoiding a FUOC (Flash Of Unstyled Content). By delaying the download of JS resources we are prioritizing CSS requests for content be shown earlier, as well as other pagelets to be downloaded.</p><h3 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h3><p>Your browser must support Javascript, since the content is embedded using Javascript. Our implementation takes into account progressive enhancement to serve pages not using BigPipe for browsers without Javascript or search engine bots (keeping SEO and accessibility).</p><h3 id="Benefits"><a href="#Benefits" class="headerlink" title="Benefits"></a>Benefits</h3><ul><li>Load time perceived by the user is better. Rendering earlier the main content of the page, browser starts making requests for resources CSS and Javascript earluer, as well as inerpreting the DOM tree.</li><li>We take advantage of the parallelism in the server side, running simultaneously multiple pagelets.</li><li>In general, improving the parallelism of the system. As the browser renders a region, some others are being transmitted through the wire and some other being built in the server.</li><li>Everything is done in a single request by the client. You could implement BigPipe using Ajax calls from the browser to generate the pagelets, but at the expense of a greater number of requests (this will be covered in another post).</li></ul><h3 id="Disadvantages"><a href="#Disadvantages" class="headerlink" title="Disadvantages"></a>Disadvantages</h3><ul><li>When you flush each pagelet more packets are sent from server to client (however we can always decide to send more than one pagelet in each flushing).</li><li>Browser has to interpret the code and insert pagelets in their containers. This causes repaintings and reflows which can be annoying to the user.</li></ul><p><a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-2">In part 2 of the tutorial</a> I explain how to use ASP.Net MVC to implement BigPipe, using RenderActions and threads pool to execute the pagelets.</p><h4 id="Other-resources"><a href="#Other-resources" class="headerlink" title="Other resources"></a>Other resources</h4><p>Some other people have implemented the basics of this technique using Java (<a href="http://www.olympum.com/java/facebook-bigpipe-in-an-async-servlet" target="_blank" rel="noopener">Bruno Fernandez-Ruiz</a> and <a href="http://codemonkeyism.com/facebook-bigpipe-java/" target="_blank" rel="noopener">Stephan Schmidt</a>) and using Node.js (<a href="http://www.subbu.org/blog/2010/07/bigpipe-done-in-node-js" target="_blank" rel="noopener">Subbu Allamaraju</a>).</p>]]></content>
    
    <summary type="html">
    
      First part of the tutorial to implement Facebook&#39;s BigPipe using ASP.Net MVC. BigPipe improves pages loading time dividing them into regions that are generated on the server concurrently.
    
    </summary>
    
    
      <category term="optimization" scheme="https://jmperezperez.com/tags/optimization/"/>
    
      <category term="flush" scheme="https://jmperezperez.com/tags/flush/"/>
    
      <category term="performance" scheme="https://jmperezperez.com/tags/performance/"/>
    
      <category term="bigpipe" scheme="https://jmperezperez.com/tags/bigpipe/"/>
    
      <category term="facebook" scheme="https://jmperezperez.com/tags/facebook/"/>
    
  </entry>
  
</feed>
